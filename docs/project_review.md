# csvpeek プロジェクトレビュー

**レビュー日**: 2026-01-13
**レビュアー**: Claude (Opus 4.5)
**バージョン**: 0.1.0

---

## 1. 総合評価

全体的に**良好な品質**のプロジェクトです。構成が適切に整理されており、テストカバレッジも高い水準にあります。ただし、将来の発展に向けていくつかの改善点と修正すべき問題点があります。

| カテゴリ | 評価 | コメント |
|---------|------|----------|
| プロジェクト構成 | ⭐⭐⭐⭐ | モジュール分離が適切 |
| コード品質 | ⭐⭐⭐ | Clippy警告あり、要修正 |
| テストカバレッジ | ⭐⭐⭐⭐ | 53テスト、主要機能をカバー |
| ドキュメント | ⭐⭐⭐⭐ | READMEが充実 |
| CI/CD | ⭐⭐⭐⭐ | マルチプラットフォームビルド対応 |
| セキュリティ | ⭐⭐⭐⭐ | 明確な脆弱性なし |

---

## 2. 要修正事項（バグ・重要な問題）

### 2.1 【重大】マルチバイト文字処理のバグ (`filter.rs:186-198`)

```rust
for (i, c) in s.chars().enumerate() {  // 問題: charのインデックスをバイトインデックスとして使用
    ...
    let col = s[..i].trim().to_string();  // i はバイトインデックスではない！
```

**問題**: `s.chars().enumerate()` で取得したインデックス `i` は文字位置であり、バイトインデックスではありません。日本語などのマルチバイト文字を含むカラム名でパニックする可能性があります。

**修正方法**:
```rust
for (i, c) in s.char_indices() {  // char_indices()を使用
    ...
    let col = s[..i].trim().to_string();  // 正しいバイトインデックス
```

### 2.2 【中】Dead Code（未使用コード）

以下のコードが使用されていません：

| ファイル | 項目 | 対応 |
|----------|------|------|
| `csv_reader.rs:47` | `detected_encoding` フィールド | 削除または活用 |
| `csv_reader.rs:51` | `from_path()` メソッド | 削除または活用 |
| `csv_reader.rs:127` | `detected_encoding()` メソッド | 削除または活用 |
| `csv_reader.rs:200` | `supported_encodings()` 関数 | 削除または活用 |
| `error.rs:22` | `ParseError` variant | 削除または活用 |

**推奨**: これらは将来の機能拡張用に意図的に残している場合は `#[allow(dead_code)]` を付与、不要なら削除してください。

### 2.3 【中】Clippy警告の修正

```bash
cargo clippy -- -D warnings  # 13個のエラー
```

主な警告：
- `needless_range_loop` (error.rs:80, 83)
- `redundant_closure` (output.rs:221, 222)
- `collapsible_if` (progress.rs:60, types.rs:90, main.rs:98)
- `manual_is_multiple_of` (progress.rs:61)

---

## 3. テストカバレッジ分析

### 3.1 現状のテスト

| カテゴリ | テスト数 | カバレッジ |
|----------|----------|------------|
| ユニットテスト (filter) | 17 | 良好 |
| ユニットテスト (types) | 7 | 良好 |
| 統合テスト (summary) | 8 | 良好 |
| 統合テスト (schema) | 3 | 基本のみ |
| 統合テスト (filter) | 7 | 良好 |
| 統合テスト (error) | 4 | 良好 |
| 統合テスト (edge) | 3 | 基本のみ |
| **合計** | **53** | - |

### 3.2 不足しているテスト

以下のテストの追加を推奨します：

1. **エンコーディング関連**
   - UTF-8以外のファイル（Shift_JIS, EUC-JP等）の読み込みテスト
   - BOM付きファイルのテスト
   - エンコーディング自動検出のテスト

2. **統計計算**
   - `stats.rs` のユニットテスト（percentile計算、標準偏差）
   - 大きな数値（オーバーフロー境界）のテスト
   - 負の数、小数点以下の精度テスト

3. **スキーマ推論**
   - `schema.rs` のユニットテスト
   - 混合型カラムの推論テスト

4. **大規模データ**
   - メモリ使用量のベンチマークテスト
   - 100万行以上のCSVファイルでのパフォーマンステスト

5. **境界値テスト**
   - 空のカラム名
   - 非常に長いカラム名/値
   - Unicode正規化の問題

---

## 4. アーキテクチャ・設計上の懸念

### 4.1 メモリ使用量（`stats.rs`）

```rust
struct ColumnAccumulator {
    numeric_values: Vec<f64>,        // 全数値を保持
    value_counts: HashMap<String, usize>, // 全ユニーク値を保持
```

**問題**: 大規模ファイルでメモリを大量消費する可能性があります。

**推奨対策**:
- サンプリングによるpercentile計算の導入
- HyperLogLog等を使用したunique count推定
- 値の頻度カウントの上限設定

### 4.2 ストリーミング処理の一部破綻

CSVファイル全体をメモリに読み込んでいます（`csv_reader.rs:65`）:

```rust
file.read_to_end(&mut bytes)?;  // ファイル全体を読み込み
```

これはエンコーディング変換のために必要ですが、非常に大きなファイルでは問題になります。

**将来の改善案**:
- チャンク単位でのエンコーディング変換
- UTF-8ファイルの場合はストリーミング処理を維持

### 4.3 エラーハンドリング

現状のエラーメッセージは適切ですが、以下の改善を推奨：

- `csv_reader.rs:73`: エンコーディングエラー時の警告が `eprintln!` で出力されている。`--quiet` フラグを尊重すべき
- フィルター式のパースエラーで、エラー位置を表示するとユーザーフレンドリー

---

## 5. CI/CD・運用

### 5.1 現状の問題

**GitHub Actions (`release.yml`) に通常のCIジョブがない**

現状、タグプッシュ時のみリリースビルドが実行されます。PRやプッシュ時に以下を実行するワークフローがありません：

```yaml
# 推奨: ci.yml を追加
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    - cargo fmt --check
    - cargo clippy -- -D warnings
    - cargo test
```

### 5.2 Rust バージョン

`mise.toml` で `rust = "1.92"` を指定していますが、これは非常に新しいバージョンです。

- MSRV (Minimum Supported Rust Version) を明記することを推奨
- `Cargo.toml` に `rust-version = "1.XX"` を追加

---

## 6. ドキュメント

### 6.1 良い点

- README.mdが充実している
- インストール方法が複数記載されている
- 使用例が豊富

### 6.2 改善点

1. **標準入力（パイプ）サポートの記載**
   - README に `cat data.csv | csvp` とあるが、コードを確認すると標準入力からの読み込みは未実装

2. **フィルター式の詳細ドキュメント**
   - 利用可能な関数（`contains`, `in`, `is_null`, `matches` 等）の詳細説明
   - 演算子の優先順位

3. **CHANGELOG.md**
   - バージョン履歴の追跡用に追加を推奨

---

## 7. セキュリティ

明確なセキュリティ上の問題は見つかりませんでした。

- 正規表現（`matches` フィルター）はユーザー入力から構築されますが、ReDoS攻撃の可能性は低い（`regex` クレートは安全な実装）
- ファイルパスはそのまま使用されますが、CLIツールとしては一般的な動作

---

## 8. 推奨アクションリスト

### 即時対応（リリース前）

- [ ] `filter.rs` のマルチバイト文字バグを修正
- [ ] Clippy警告を全て解消
- [ ] Dead codeの整理（削除 or `#[allow(dead_code)]`）

### 短期（v0.2.0 までに）

- [ ] CI ワークフロー（fmt, clippy, test）の追加
- [ ] 標準入力からの読み込みを実装（または README から削除）
- [ ] エンコーディング関連のテスト追加
- [ ] stats.rs のユニットテスト追加

### 中期（v1.0 までに）

- [ ] 大規模ファイル対応（メモリ効率化）
- [ ] MSRV の明記
- [ ] CHANGELOG.md の追加
- [ ] パフォーマンスベンチマーク

---

## 9. まとめ

csvpeekは全体的によく設計されたプロジェクトです。特に以下の点が優れています：

- **モジュール構成**: 責務が明確に分離されている
- **テストカバレッジ**: 主要な機能が網羅されている
- **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージ
- **マルチプラットフォーム**: 6つのターゲットへのビルド対応

ただし、`filter.rs` のマルチバイト文字処理バグは**本番利用前に修正必須**です。また、Clippy警告の解消とCIワークフローの追加により、コード品質の維持が容易になります。

将来の機能拡張に向けて、メモリ効率の改善と大規模ファイル対応を検討することを推奨します。
